<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Document ‚Äî StudyCore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b0f17; color:#e5e7eb; }
    .nav-glass { background: linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,.2)); backdrop-filter: blur(10px); }
    .dropzone { border:2px dashed rgba(255,255,255,.25); border-radius:18px; padding:60px 16px; text-align:center; background: rgba(255,255,255,.05); transition:.2s; }
    .dropzone.drag { border-color:#6ee7ff; box-shadow: 0 0 0 4px rgba(110,231,255,.12) inset; }
    .glass { background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.10); border-radius:16px; }
    .btn-acc { background: linear-gradient(90deg, #7c3aed, #6ee7ff); border:none; color:#0b0f17 !important; font-weight:700; }

    /* Flashcards (high contrast) */
    .flashcard{ width:320px; height:200px; margin:20px auto; perspective:1000px; cursor:pointer; }
    .flashcard .inner{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .65s; }
    .flashcard.flipped .inner{ transform: rotateY(180deg); }
    .flashcard .face{
      position:absolute; inset:0; backface-visibility:hidden;
      display:flex; align-items:center; justify-content:center;
      border-radius: 14px; padding: 18px;
      background: linear-gradient(180deg, #1b2230, #0f1522);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 28px rgba(0,0,0,.5), inset 0 1px 0 rgba(255,255,255,.05);
      color: #e8f0ff; font-size: 1.05rem; font-weight: 700; text-align:center;
    }
    .flashcard .back{ transform: rotateY(180deg); background: linear-gradient(180deg, #101826, #0b1220); color:#fff; font-weight:600; }

    /* Study guide contrast */
    .sg-title{ color:#EAF2FF !important; font-weight:800; }
    .sg-summary{ color:#CFE3FF !important; opacity:1 !important; }

    /* Upload results contrast (questions, headings, strong) */
    #results .card.glass h5,
    #results .card.glass h4,
    #results .card.glass strong{ color:#F6FAFF !important; }

    /* Score line always bright */
    .quiz-score-text{ color:#EAF2FF !important; font-weight:700; opacity:1 !important; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg nav-glass sticky-top px-3">
  <a class="navbar-brand d-flex align-items-center gap-2" href="/">
    <img src="{{ url_for('static', filename='Sattys.png') }}" alt="StudyCore logo" width="28" height="28" class="rounded-circle" style="box-shadow:0 0 0 2px rgba(255,255,255,.12);">
    <span style="font-weight:900;background:linear-gradient(90deg,#fff,#a5f3fc 55%,#c4b5fd 90%);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;">
      Study<span style="filter:drop-shadow(0 0 8px rgba(124,58,237,.45))">Core</span>
    </span>
  </a>
  <div class="ms-auto d-flex gap-2">
    <a href="/upload" class="btn btn-sm btn-outline-light">Upload</a>
    <a href="#" class="btn btn-sm btn-acc">Login</a>
  </div>
</nav>

<div class="container py-5">
  <h2 class="text-center fw-bold">üìÑ Upload Your Study Document</h2>
  <p class="text-center text-secondary">PDF, TXT, DOC, DOCX supported</p>

  <div class="dropzone my-4" id="drop-area">
    <input type="file" id="docUpload" accept=".pdf,.txt,.doc,.docx" hidden />
    <label for="docUpload" class="btn btn-acc">üì§ Click to Select</label>
    <p class="mt-3" id="upload-status"></p>
  </div>

  <div class="d-flex justify-content-center gap-2">
    <button class="btn btn-outline-light" onclick="submitDoc('flashcards')">Generate Flashcards</button>
    <button class="btn btn-outline-light" onclick="submitDoc('quiz')">Generate Quiz</button>
    <button class="btn btn-outline-light" onclick="submitDoc('studyguide')">Generate Study Guide</button>
  </div>

  <div id="loadingSpinner" class="text-info my-4 text-center" style="display:none;">
    <div class="spinner-border text-info" role="status"></div>
    <p class="mt-2">Generating, please wait‚Ä¶</p>
  </div>

  <div id="results" class="mt-4"></div>
</div>

<script>
"use strict";

function submitDoc(type){
  const f = document.getElementById('docUpload');
  if(!f.files || !f.files[0]) return alert("Please upload a document first.");
  const formData = new FormData();
  formData.append("file", f.files[0]);

  document.getElementById("loadingSpinner").style.display = "block";
  const results = document.getElementById("results");
  results.innerHTML = "";

  fetch(`/generate_${type}_from_doc`, { method:'POST', body: formData })
    .then(res => res.json())
    .then(data => {
      document.getElementById("loadingSpinner").style.display = "none";
      const c = document.createElement("div");
      c.className = "glass p-3";
      if(type==="flashcards" && data.flashcards){ renderFlashcards(c, data.flashcards); }
      else if(type==="quiz" && data.quiz){ renderDocQuiz(c, data.quiz); }
      else if(type==="studyguide" && data.studyguide){ renderStudyGuide(c, data.studyguide); }
      else { c.innerHTML = `<p class="text-danger">‚ùå Failed: ${data.error || "Unknown error"}</p>`; }
      results.appendChild(c);
    })
    .catch(err => {
      console.error(err);
      document.getElementById("loadingSpinner").style.display = "none";
      alert("Error generating "+type);
    });
}

function renderFlashcards(container, cards){
  let idx = 0;
  container.innerHTML = `
    <h4>üÉè Flashcards</h4>
    <div class="flashcard" id="fc">
      <div class="inner">
        <div class="face"><strong id="fc-front"></strong></div>
        <div class="face back"><span id="fc-back"></span></div>
      </div>
    </div>
    <div class="text-center">
      <button class="btn btn-outline-light me-2" id="prev">‚¨ÖÔ∏è Prev</button>
      <button class="btn btn-outline-light" id="next">‚û°Ô∏è Next</button>
      <p class="mt-2" id="fc-count"></p>
    </div>`;
  const fc = container.querySelector("#fc");
  const front = container.querySelector("#fc-front");
  const back = container.querySelector("#fc-back");
  const count = container.querySelector("#fc-count");
  function load(i){
    const card = cards[i] || {};
    front.textContent = card.term || "‚Äî";
    back.textContent = card.definition || "‚Äî";
    count.textContent = `Card ${i+1} of ${cards.length}`;
  }
  fc.addEventListener("click", ()=> fc.classList.toggle("flipped"));
  container.querySelector("#prev").addEventListener("click", ()=>{ idx=Math.max(0,idx-1); fc.classList.remove("flipped"); load(idx); });
  container.querySelector("#next").addEventListener("click", ()=>{ idx=Math.min(cards.length-1,idx+1); fc.classList.remove("flipped"); load(idx); });
  load(0);
}

function renderDocQuiz(container, quiz){
  if(!Array.isArray(quiz) || !quiz.length){
    container.innerHTML = `<p class="text-warning">No quiz questions returned.</p>`;
    return;
  }
  let i=0, score=0;

  const draw = ()=>{
    const q = quiz[i];
    let html = `<h4>üìù Quiz</h4>
      <div class="card glass p-3">
        <h5>${q.question}</h5>
        <div class="mt-3">`;
    (q.options||[]).forEach(opt=>{
      const L = opt.trim().charAt(0);
      html += `<button class="btn btn-outline-light w-100 my-1 text-start btn-answer" data-letter="${L}">${opt}</button>`;
    });
    html += `</div>
      <div class="d-flex justify-content-end mt-3">
        ${i<quiz.length-1 ? `<button class="btn btn-secondary" id="next">Next</button>`:`<button class="btn btn-acc" id="finish">Finish</button>`}
      </div></div>`;
    container.innerHTML = html;

    // answer handlers
    container.querySelectorAll(".btn-answer").forEach(b=>{
      b.addEventListener("click", ()=>{
        const sel = b.dataset.letter;
        const corr = (q.answer||"").trim().charAt(0);
        container.querySelectorAll(".btn-answer").forEach(x=>{
          x.disabled = true;
          const L = x.dataset.letter;
          x.classList.remove("btn-outline-light");
          if(L===corr) x.classList.add("btn-success");
          else if(x===b) x.classList.add("btn-danger");
        });
        if(sel===corr) score++;
      });
    });

    // nav handlers
    const nextBtn = container.querySelector("#next");
    if(nextBtn) nextBtn.addEventListener("click", ()=>{ i++; draw(); });

    const fin = container.querySelector("#finish");
    if (fin) fin.addEventListener("click", () => {
      const pct = Math.round((score / quiz.length) * 100);
      container.innerHTML = `
        <div class="card glass p-4 text-center">
          <h4>‚úÖ Quiz Complete!</h4>
          <p class="quiz-score-text">Your Score: ${score} / ${quiz.length} (${pct}%)</p>
          <div class="d-flex justify-content-center mt-3">
            <button class="btn btn-outline-light" id="retryDocQuiz">üîÅ Retry</button>
          </div>
        </div>`;
      container.querySelector("#retryDocQuiz").addEventListener("click", ()=>{ i=0; score=0; draw(); });
    });
  };

  draw();
}

function renderStudyGuide(container, topics){
  let html = `<h4>üìö Extracted Study Guide</h4>`;
  topics.forEach(t=>{
    html += `<div class="card glass p-3 mb-2">
      <h6 class="fw-bold sg-title">${t.title}</h6>
      <p class="mb-1 sg-summary">${t.summary || ""}</p>
      ${t.video ? `<a class="btn btn-sm btn-acc w-100" target="_blank" href="${t.video}">Watch video ‚Üó</a>` : ""}
    </div>`;
  });
  container.innerHTML = html;
}

// Drag & drop
const dropArea = document.getElementById('drop-area');
dropArea.addEventListener("dragover", e=>{ e.preventDefault(); dropArea.classList.add("drag"); });
dropArea.addEventListener("dragleave", ()=> dropArea.classList.remove("drag"));
dropArea.addEventListener("drop", (e)=>{
  e.preventDefault(); dropArea.classList.remove("drag");
  const files = e.dataTransfer.files;
  if(files.length){
    const input = document.getElementById("docUpload");
    const dt = new DataTransfer();
    Array.from(files).forEach(f=>dt.items.add(f));
    input.files = dt.files;
    document.getElementById("upload-status").textContent = "‚úÖ Uploaded: " + input.files[0].name;
  }
});
document.getElementById("docUpload").addEventListener("change", function(){
  const name = this.files[0]?.name || "None";
  document.getElementById("upload-status").textContent = "‚úÖ Uploaded: " + name;
});
</script>
</body>
</html>
