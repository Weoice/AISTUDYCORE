<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #040303;
      color: white;
      text-align: center;
      padding-top: 50px;
    }
    .upload-box {
      border: 2px dashed #aaa;
      border-radius: 10px;
      padding: 60px;
      margin: 0 auto 30px;
      width: 60%;
      background: #1e1e1e;
      color: #ccc;
    }
    .upload-box:hover {
      border-color: #00bcd4;
      color: #00bcd4;
    }
    .upload-btns .btn {
      margin: 10px;
    }
    .hidden { display: none; }

    .flashcard-flip {
  perspective: 1000px;
  width: 300px;
  height: 180px;
  margin: 20px auto;
  cursor: pointer;
}
.flashcard-inner {
  position: relative;
  width: 100%;
  height: 100%;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}
.flashcard-flip:hover .flashcard-inner {
  transform: rotateY(180deg);
}
.flashcard-front, .flashcard-back {
  position: absolute;
  width: 100%;
  height: 100%;
  background: #1e1e1e;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 20px;
  backface-visibility: hidden;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  text-align: center;
}
.flashcard-back {
  transform: rotateY(180deg);
}
.quiz-option-btn {
  background-color: #222;
  color: white;
  border: 1px solid #00bcd4;
  
}
.quiz-option-btn:hover {
  background-color: #00bcd4;
  color: black;
}
.dark-box {
  background-color: #1e1e1e;
  color: #fff;
  border: 1px solid #444;
}

.correct {
  background-color: #28a745 !important; /* green */
  color: white;
}
.incorrect {
  background-color: #dc3545 !important; /* red */
  color: white;
}








  </style>
</head>
<body>


<nav class="navbar navbar-dark bg-dark justify-content-between px-4">
  <a class="navbar-brand text-white" href="/" >Course Generator</a>
  <div>
    <b><a href="/upload" class="btn btn-outline-light me-2">üì§ Upload Document</a></div></b>
    <button class="btn btn-outline-info">Login</button>
  </div>
</nav>


<h2 class="my-4">üìÑ Upload Your Study Document</h2>

<div class="upload-box" id="drop-area">
  <input type="file" id="docUpload" accept=".pdf,.txt,.doc,.docx" hidden />
  <label for="docUpload" class="btn btn-outline-info btn-lg">üì§ Drag & Drop or Click to Upload</label>
</div>

<p id="upload-status" style="color: #00bcd4; margin-bottom: 20px;"></p>

<div class="upload-btns">
  <form action="/flashcards/{{ output.subject }}" method="get" style="display: inline;">
  <button class="btn btn-outline-light">Flashcards</button>
</form>

  <button class="btn btn-outline-light" onclick="submitDoc('quiz')">Generate Quiz</button>

  <div id="quizResults" class="mt-4 p-3 rounded shadow-sm dark-box"></div>


  <button class="btn btn-outline-light" id="studyBtn" onclick="submitDoc('studyguide')">Generate Study Guide</button>
</div>
<div id="loadingSpinner" class="text-info my-3" style="display: none;">
  <div class="spinner-border text-info" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p>Generating, please wait...</p>
</div>

  


<script>
function submitDoc(type) {
  const fileInput = document.getElementById('docUpload');
  if (!fileInput.files[0]) return alert("Please upload a document first.");

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  
  document.getElementById("loadingSpinner").style.display = "block";

 
  document.querySelectorAll(".dynamic-output")?.forEach(el => el.remove());

  fetch(`/generate_${type}_from_doc`, {
    method: 'POST',
    body: formData
  })
  
  .then(res => res.json())
  .then(data => {
    
    document.getElementById("loadingSpinner").style.display = "none";

    


    const container = document.createElement("div");
    container.classList.add("dynamic-output");
    document.body.appendChild(container);
    container.style.marginTop = "30px";
    container.style.padding = "20px";
    container.style.background = "#222";
    container.style.borderRadius = "10px";
    container.style.maxWidth = "700px";
    container.style.marginLeft = "auto";
    container.style.marginRight = "auto";

    // üîÅ Flashcard rendering
    if (type === "flashcards" && data.flashcards) {
      let flashcards;
      try {
        flashcards = typeof data.flashcards === "string"
          ? JSON.parse(data.flashcards)
          : data.flashcards;
      } catch (err) {
        container.innerHTML = "<p style='color: red;'>‚ùå Failed to parse flashcards JSON.</p>";
        document.body.appendChild(container);
        return;
      }

      let currentCard = 0;

      const renderFlashcard = () => {
        const fc = flashcards[currentCard];
        container.innerHTML = `
          <h4 class="mb-3">üÉè Flashcards</h4>
          <div class="flashcard-flip" onclick="flipCard()">
            <div class="flashcard-inner" id="card-inner">
              <div class="flashcard-front"><strong>${fc.term}</strong></div>
              <div class="flashcard-back">${fc.definition}</div>
            </div>
          </div>
          <div class="mt-3">
            <button class="btn btn-outline-light me-2" onclick="prevCard()">‚¨ÖÔ∏è Prev</button>
            <button class="btn btn-outline-light" onclick="nextCard()">‚û°Ô∏è Next</button>
            <p class="mt-2">Card ${currentCard + 1} of ${flashcards.length}</p>
          </div>
        `;
      };

      window.flipCard = () => {
        const card = document.getElementById("card-inner");
        card.classList.toggle("flipped");
      };

      window.prevCard = () => {
        if (currentCard > 0) {
          currentCard--;
          renderFlashcard();
        }
      };

      window.nextCard = () => {
        if (currentCard < flashcards.length - 1) {
          currentCard++;
          renderFlashcard();
        }
      };

      renderFlashcard();
    }

    // üìù Quiz rendering
    else if (type === "quiz") {
      let quiz;
      try {
        quiz = typeof data.quiz === "string"
          ? JSON.parse(data.quiz)
          : data.quiz;

        if (!Array.isArray(quiz)) throw new Error("Quiz is not an array");
      } catch (err) {
        console.error("‚ùå Quiz parsing failed:", err);
        container.innerHTML = "<p style='color: red;'>‚ùå Failed to parse quiz content.</p>";
        
        return;
      }

      let currentIndex = 0;
      let score = 0;

      const renderQuestion = () => {
        const q = quiz[currentIndex];
        container.innerHTML = `
          <h4 class="mb-3">üìù Quiz</h4>
          <div class="card p-3">
            <h5>${q.question}</h5>
            <div class="mt-3" id="options-block"></div>
            <div class="d-flex justify-content-between mt-3">
              <button class="btn btn-info btn-sm" onclick="alert('üß† How to solve coming soon!')">üß† How to solve</button>
              ${
                currentIndex < quiz.length - 1
                  ? `<button class="btn btn-secondary" onclick="nextDocQuiz()">Next</button>`
                  : `<button class="btn btn-success" onclick="showDocQuizResults()">Finish</button>`
              }
            </div>
          </div>
        `;

        const optBlock = container.querySelector("#options-block");

        q.options.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "btn btn-outline-dark btn-sm w-100 my-2";


          btn.textContent = opt;
          btn.onclick = () => {
  const selectedLetter = btn.textContent.trim().charAt(0); // e.g. "C"
  const correctLetter = q.answer.trim().charAt(0);

  if (selectedLetter === correctLetter) {
    btn.classList.add("correct");
    score++;
  } else {
    btn.classList.add("incorrect");
  }

  // Show the correct one
  Array.from(optBlock.children).forEach(b => {
    b.disabled = true;
    if (b.textContent.trim().charAt(0) === correctLetter) {
      b.classList.add("correct");
    }
  });
};



          optBlock.appendChild(btn);
        });
      };

      window.nextDocQuiz = () => {
        currentIndex++;
        renderQuestion();
      };

      window.showDocQuizResults = () => {
        const percent = Math.round((score / quiz.length) * 100);
        container.innerHTML = `
          <div class="quiz-result-box text-center p-4">
            <h4>‚úÖ Quiz Complete!</h4>
            <p>Your Score: ${score} / ${quiz.length}</p>
            <p><strong>${percent}%</strong></p>
          </div>
`;

      };

      renderQuestion();
    }

    // ‚ùå Fallback for unrecognized or empty result
    else {
      container.innerHTML = "<p style='color: red;'>‚ùå Failed to generate content.</p>";
    }

    document.body.appendChild(container);
  })
  fetch(`/generate_${type}_from_doc`, {
  method: 'POST',
  body: formData
})
.then(res => res.json())
.then(data => {
  document.getElementById("loadingSpinner").style.display = "none";

  // ... your rendering logic (quiz, flashcards, etc.)
})
.catch(err => {
  document.getElementById("loadingSpinner").style.display = "none";
  console.error("‚ùå Error during generation:", err);
  alert("Error generating " + type);
});

}





const dropArea = document.getElementById('drop-area');
dropArea.addEventListener("dragover", (e) => {
  e.preventDefault();
  dropArea.classList.add("border-primary");
});
dropArea.addEventListener("dragleave", () => {
  dropArea.classList.remove("border-primary");
});
dropArea.addEventListener("drop", (e) => {
  e.preventDefault();
  dropArea.classList.remove("border-primary");

  const droppedFiles = e.dataTransfer.files;
  if (droppedFiles.length > 0) {
    const fileInput = document.getElementById("docUpload");
const dataTransfer = new DataTransfer();
for (let file of e.dataTransfer.files) {
  dataTransfer.items.add(file);
}
fileInput.files = dataTransfer.files;
document.getElementById("upload-status").textContent = "‚úÖ Uploaded: " + fileInput.files[0].name;

const msg = document.createElement("p");
msg.id = "docStatus";
msg.innerText = "‚úÖ Document uploaded: " + fileInput.files[0].name;
msg.style.color = "#00ffcc";
dropArea.appendChild(msg);

console.log("Dropped file:", fileInput.files[0]);

    console.log("Dropped file:", droppedFiles[0]);
  }
});

document.getElementById("docUpload").addEventListener("change", function () {
  const name = this.files[0]?.name || "None";
  document.getElementById("upload-status").textContent = "‚úÖ Uploaded: " + name;
});


</script>

</body>
</html>
