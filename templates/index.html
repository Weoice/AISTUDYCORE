<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Study Guide</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #040303;
      font-family: 'Segoe UI', sans-serif;
      color: white;
    }
    .container {
      padding-top: 30px;
    }
    .tab-content {
      margin-top: 1rem;
    }
    .video-card {
  margin-bottom: 20px;
  padding: 5px;
  width: 100%;
  max-width: 320px;
  font-size: 0.85rem;
}
.video-thumb {
  max-width: 100%;
  border-radius: 8px;
}


    .btn-answer {
      margin: 5px 0;
      width: 100%;
    }
    .correct { background-color: #d4edda !important; }
    .incorrect { background-color: #f8d7da !important; }
    .custom-cyan {
      background-color: #00bcd4 !important;
      color: white;
    }
    #loadingBar {
      height: 16px;
      width: 70%;
      margin: 40px auto;
      display: none;
    }
    .logo-img {
      width: 300px;
      height: 220px;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      margin: 0 auto 20px;
    }
    .flashcard { padding: 20px; border-radius: 10px; background: #f4f4f4; margin: 10px 0; }
    #notes-sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.2);
      padding: 20px;
      transition: right 0.3s ease-in-out;
      z-index: 1000;
    }
    #notes-sidebar.show { right: 0; }
    #toggle-notes { position: fixed; top: 50%; right: 0; transform: translateY(-50%); z-index: 1001; }
    #tinyLoadingBar {
  height: 6px;
  width: 100%;
  position: fixed;
  bottom: 0;
  left: 0;
  background: transparent;
  display: none;
  z-index: 9999;
}
.ratio.ratio-16x9 {
    max-width: 600px;
    margin: 0 auto 1rem; 
  }
   #videos .row.justify-content-center {
    max-width: 900px;    /* whichever max width you prefer */
    margin: 0 auto;      /* center it */
    gap: 1rem;           /* grid gap */
  }

  
  #videos .card {
    max-width: 280px;   
    margin: 0 auto;      
  }
  #videos .card-body {
    padding: 0.5rem;     
  }

  
  #videos .card-img-top {
    margin-bottom: 0.5rem;
  }
#tinyProgressFill {
  height: 100%;
  width: 0%;
  background-color: #00bcd4;
  transition: width 0.2s ease;
}
.navbar-brand {
  font-size: 1.4rem;
  font-weight: bold;
}

@media (max-width: 768px) {
  .video-card {
    margin-bottom: 20px;
  }
  .video-thumb {
    width: 100%;
    height: auto;
  }
}

  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-4">
  <a class="navbar-brand" href="#">üìòStudyCore</a>
  <div class="ms-auto d-flex">
    <a href="/upload" class="btn btn-outline-light me-2">Upload Document</a>
    <a href="/login" class="btn btn-primary">Login</a>
  </div>
</nav>
<div class="mt-4"></div>


<div class="container">
  <img src="{{ url_for('static', filename='sattys.png') }}" alt="Sattys Logo" class="logo-img">

  <form method="POST">
    <div class="input-group mb-4">
      <input type="text" name="subject" class="form-control" placeholder="Enter a topic (e.g. Photosynthesis)" required>
      <button class="btn btn-primary">Generate</button>
    </div>
  </form>

  <div id="loadingBar" class="progress">
    <div id="progressFill" class="progress-bar progress-bar-striped progress-bar-animated custom-cyan" style="width: 0%">Loading...</div>
  </div>
  {% if output %}
    <ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <button class="nav-link active" id="course-tab" data-bs-toggle="tab" data-bs-target="#course">üìò AI Course</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="quiz-tab" data-bs-toggle="tab" data-bs-target="#quiz">üß† Quiz</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos">üìº Extra Videos</button>
  </li>
  <li class="nav-item">
    <form method="GET" action="/flashcards/{{ output.subject | urlencode }}">
      <button type="submit" class="nav-link btn btn-link" style="text-decoration: none;">üìá Flashcards</button>
    </form>
  </li>
</ul>


    <div class="tab-content">
      <div class="tab-pane fade show active" id="plan"><pre>{{ output.plan }}</pre></div>
      <div id="mainQuizContainer">
    
</div>

      <div class="tab-pane fade" id="videos">
  <h5 class="my-3">üì∫ Extra Videos on {{ output.subject }}</h5>
  <p>Recommended Channel: <strong>{{ output.channel }}</strong></p>
  <div class="row justify-content-center g-3">
  {% for video in output.videos %}
  <div class="col-sm-6 col-md-4 col-lg-3">
    <div class="card bg-dark text-white h-100 shadow-sm" style="min-height: 280px;">
      <a href="{{ video.link }}" target="_blank">
        <img src="https://img.youtube.com/vi/{{ video.link.split('=')[-1] }}/0.jpg" class="card-img-top rounded" style="max-height: 160px; object-fit: cover;">
        <div class="card-body">
          <p class="card-text" style="font-size: 0.9rem;">{{ video.title }}</p>
        </div>
      </a>
    </div>
  </div>
  {% endfor %}
</div>


</div>

      <div class="tab-pane fade" id="flashcards">
        {% for topic in output.topics %}
          <div class="flashcard"><strong>{{ topic.title }}</strong><br>{{ topic.description }}</div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
  {% if output and output.topics %}
    <h4 class="mt-4">üìö Course: {{ output.subject }}</h4>
    {% for lesson in output.topics %}
    <div class="card my-4">
      <div class="card-body">
        <h5 class="card-title">üéì {{ lesson.title }}</h5>
        <p>{{ lesson.description }}</p>
        {% if lesson.video %}
        <div class="ratio ratio-16x9 mb-3">
          <iframe src="{{ lesson.video | replace('watch?v=', 'embed/') }}" frameborder="0" allowfullscreen></iframe>
        </div>
        {% endif %}
        {% if lesson.quiz %}
        <h6>üìù Quiz</h6>
        {% for q in lesson.quiz %}
        <div class="mb-3">
          <strong>{{ q.question }}</strong>
          <div class="mt-2">
            {% for opt in q.options %}
            <button class="btn btn-outline-secondary btn-sm btn-answer" onclick="checkLocalAnswer(this, '{{ opt[0] }}', '{{ q.answer }}')">{{ opt }}</button>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <form method="POST" class="text-center" id="continue-form">
      <input type="hidden" name="subject" value="{{ output.subject }}">
      {% for topic in output.topics %}
      <input type="hidden" name="past_topics" value="{{ topic.title.split(': ', 1)[1] }}">
      <input type="hidden" name="past_descriptions" value="{{ topic.description }}">
      <input type="hidden" name="past_videos" value="{{ topic.video }}">
      <input type="hidden" name="past_quizzes" value='{{ topic.quiz | tojson | safe }}'>
      {% endfor %}
      <button id="continueCourseBtn" class="btn btn-primary" data-clicks="0">Continue Course</button>

    </form>
  {% endif %}



<div id="toggle-notes"><button class="btn btn-dark" onclick="toggleNotes()">üóíÔ∏è Notes</button></div>
<div id="notes-sidebar">
  <div class="d-flex justify-content-between align-items-center">
    <h5>üóíÔ∏è Notes</h5>
    <button class="btn-close" aria-label="Close" onclick="toggleNotes()"></button>
  </div>
  <textarea class="form-control mt-2" rows="20" placeholder="Write your notes here..."></textarea>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  
function showLoadingBar() {
  const bar = document.getElementById("loadingBar");
  const fill = document.getElementById("progressFill");
  bar.style.display = "block";
  fill.style.width = "0%";
  let width = 0;
  const interval = setInterval(() => {
    width += 5;
    fill.style.width = width + "%";
    if (width >= 100) clearInterval(interval);
  }, 100);
  return interval;
}


function hideLoadingBar() {
  const bar = document.getElementById("loadingBar");
  const fill = document.getElementById("progressFill");
  bar.style.display = "none";
  fill.style.width = "0%";
}
function showTinyLoadingBar() {
  const bar = document.getElementById("tinyLoadingBar");
  const fill = document.getElementById("tinyProgressFill");
  bar.style.display = "block";
  fill.style.width = "0%";
  let width = 0;
  const interval = setInterval(() => {
    width += 5;
    fill.style.width = width + "%";
    if (width >= 100) clearInterval(interval);
  }, 100);
  return interval;
}

function hideTinyLoadingBar() {
  const bar = document.getElementById("tinyLoadingBar");
  const fill = document.getElementById("tinyProgressFill");
  bar.style.display = "none";
  fill.style.width = "0%";
}

function checkLocalAnswer(button, selected, correct) {
  const buttons = button.parentNode.querySelectorAll('button');
  buttons.forEach(b => {
    b.disabled = true;
    const bLetter = b.textContent.trim().charAt(0);
    if (bLetter === correct) {
      b.classList.remove('btn-outline-secondary');
      b.classList.add('btn-success');
    } else if (b === button) {
      b.classList.remove('btn-outline-secondary');
      b.classList.add('btn-danger');
    }
  });
}

function toggleNotes() {
  const sidebar = document.getElementById('notes-sidebar');
  const toggleBtn = document.getElementById('toggle-notes');
  sidebar.classList.toggle('show');
  toggleBtn.style.display = sidebar.classList.contains('show') ? 'none' : 'block';
}
function loadFlashcards(subject) {
  showLoadingBar(); // Keep them on current page with loading bar

  fetch("/generate_flashcards_from_subject", {
    method: "POST",
    body: JSON.stringify({ subject }),
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(response => response.json())
  .then(data => {
    sessionStorage.setItem("flashcardsData", JSON.stringify(data));
    window.location.href = `/flashcards/${encodeURIComponent(subject)}`;
  })
  .catch(error => {
    console.error("Flashcards fetch failed:", error);
    alert("Failed to generate flashcards.");
    hideLoadingBar();
  });
}



window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("form").forEach(form => {
    form.addEventListener("submit", function (e) {
      const loading = showLoadingBar();
      e.preventDefault(); // stop default
      setTimeout(() => form.submit(), 200); // wait 200ms before submitting
    });
  });
});




  const quizScript = document.getElementById("quiz-data");
  if (quizScript) {
    const quiz = JSON.parse(quizScript.textContent);
    const container = document.getElementById("quiz-block");
    let currentIndex = 0;
    let score = 0;

    const renderQuestion = () => {
      if (!quiz.length) return;
      const q = quiz[currentIndex];
      let html = `<div class="card p-3"><h5>${q.question}</h5>`;
      q.options.forEach((opt) => {
        const letter = opt.trim().charAt(0);
        html += `
          <button class="btn btn-outline-primary btn-answer w-100 my-1"
              onclick="checkAnswer(this, '${letter}', '${q.answer}')">
              ${opt}
          </button>`;
      });
      html += `
        <div class="d-flex justify-content-between mt-2">
          <button class="btn btn-info btn-sm" onclick="alert('How-to-solve coming soon!')">üß† How to solve</button>
          ${currentIndex < quiz.length - 1
              ? `<button class="btn btn-secondary" onclick="nextQuestion()">Next</button>`
              : `<button class="btn btn-success" onclick="showResults()">Finish</button>`}
        </div>
      </div>`;
      container.innerHTML = html;
    };

    window.checkAnswer = (btn, selected, correct) => {
      const buttons = document.querySelectorAll('.btn-answer');
      buttons.forEach(b => {
        const bLetter = b.textContent.trim().charAt(0);
        b.disabled = true;
        b.classList.remove('btn-outline-primary');
        if (bLetter === correct) {
          b.classList.add('btn-success');
          if (b === btn) score++;
        } else if (b === btn) {
          b.classList.add('btn-danger');
        }
      });
    };

    window.nextQuestion = () => {
      if (currentIndex < quiz.length - 1) {
        currentIndex++;
        renderQuestion();
      }
    };

    window.showResults = () => {
      const percent = Math.round((score / quiz.length) * 100);
      container.innerHTML = `
        <div class="card p-4 text-center">
          <h4>‚úÖ Quiz Complete!</h4>
          <p>Your Score: ${score} / ${quiz.length}</p>
          <p><strong>${percent}%</strong></p>
        </div>`;
    };

    renderQuestion();
  }

</script>
{% if output %}
<script id="jinja-data" type="application/json">
{
  "subject": {{ output.subject | tojson }},
  "topics": {{ output.topics | map(attribute='title') | list | tojson }}
}
</script>
{% endif %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const continueBtn = document.getElementById("continueCourseBtn");

    if (continueBtn) {
      continueBtn.addEventListener("click", function () {
        let clicks = parseInt(continueBtn.getAttribute("data-clicks")) || 0;

        if (clicks >= 4) {
          alert("üö´ You‚Äôve reached the 4-time limit for continuing the course.");
          return;
        }

        continueBtn.setAttribute("data-clicks", clicks + 1);
        // Proceed with your normal generation logic (or trigger the form submit, etc.)
      });
    }
  });
</script>

<script>

let quizLoaded = false;

document.querySelector('[data-bs-target="#quiz"]').addEventListener('click', function () {
    if (quizLoaded) return;
    const loadingInterval = showTinyLoadingBar();

    

    const container = document.getElementById("mainQuizContainer");
    container.innerHTML = "<p>Generating quiz...</p>";

    // Load JSON from hidden script
    const jsonData = JSON.parse(document.getElementById("jinja-data").textContent);
    const subject = jsonData.subject;
    const topics = jsonData.topics;

    fetch("/generate_quiz", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ subject, topics })
    })
    .then(res => res.json())
   .then(data => {
    clearInterval(loadingInterval);
    hideTinyLoadingBar();

    if (data.quiz) {
        let currentIndex = 0;
        let score = 0;
        
        const renderQuestion = () => {
            const q = data.quiz[currentIndex];
            let html = `
                <div class="card p-3">
                    <h5>${q.question}</h5>
                    <div class="mt-3">`;

            q.options.forEach(opt => {
                const letter = opt.trim().charAt(0);
                html += `
                <button class="btn btn-outline-primary btn-answer w-100 my-1"
                    onclick="checkMainAnswer(this, '${letter}', '${q.answer}')">
                    ${opt}
                </button>`;
            });

            html += `</div>
                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-sm btn-info" onclick="alert('üß† How to solve coming soon!')">üß† How to solve</button>
                    ${currentIndex < data.quiz.length - 1
                        ? `<button class="btn btn-secondary" onclick="nextMainQuestion()">Next</button>`
                        : `<button class="btn btn-success" onclick="showMainResults()">Finish</button>`}
                </div>
            </div>`;

            container.innerHTML = html;
        };

        window.checkMainAnswer = (btn, selected, correct) => {
            const buttons = btn.parentNode.querySelectorAll('.btn-answer');
            buttons.forEach(b => {
                b.disabled = true;
                const bLetter = b.textContent.trim().charAt(0);
                b.classList.remove('btn-outline-primary');
                if (bLetter === correct) {
                    b.classList.add('btn-success');
                    if (b === btn) score++;
                } else if (b === btn) {
                    b.classList.add('btn-danger');
                }
            });
        };

        window.nextMainQuestion = () => {
            currentIndex++;
            renderQuestion();
        };

        window.showMainResults = () => {
  const percent = Math.round((score / data.quiz.length) * 100);
  container.innerHTML = `
    <div class="card p-4 text-center">
      <h4>‚úÖ Quiz Complete!</h4>
      <p>Your Score: ${score} / ${data.quiz.length}</p>
      <p><strong>${percent}%</strong></p>
      <div class="d-flex justify-content-center gap-2 mt-3">
        <button class="btn btn-outline-primary" onclick="retryMainQuiz()">üîÅ Retry Quiz</button>
        <button class="btn btn-outline-danger" onclick="regenerateMainQuiz()">‚ôªÔ∏è Regenerate Quiz</button>
      </div>
    </div>`;
};

window.retryMainQuiz = () => {
  currentIndex = 0;
  score = 0;
  renderQuestion();
};

window.regenerateMainQuiz = () => {
  quizLoaded = false;
  document.querySelector('[data-bs-target="#quiz"]').click();
};


        renderQuestion();
        quizLoaded = true;
    } else {
        container.innerHTML = "<p>‚ùå Failed to load quiz. Please try again.</p>";
    }



})
.catch(error => {
    console.error("Quiz generation failed:", error);
    clearInterval(loadingInterval);
    hideTinyLoadingBar();
    container.innerHTML = "<p>‚ùå An error occurred while generating quiz. Please try again.</p>";
});
});
document.getElementById("continue-form")?.addEventListener("submit", function (e) {
  showTinyLoadingBar();
});

</script>

<div id="tinyLoadingBar">
  <div id="tinyProgressFill"></div>
</div>
</body>
</html>
