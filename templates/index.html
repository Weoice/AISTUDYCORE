<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>StudyCore ‚Äî AI Study Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --glass: rgba(255,255,255,0.08); --acc:#6ee7ff; --acc2:#7c3aed; }
    body { background: radial-gradient(1200px 600px at 20% -10%, #1b1f2b 0%, #0b0f17 60%) fixed; color:#e5e7eb; font-family: ui-sans-serif,system-ui; }
    .nav-glass { background: linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,.2)); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,.08); }
    .hero { max-width: 980px; margin: 40px auto 16px; text-align:center; padding: 16px; }
    .hero h1 { font-weight: 800; background: linear-gradient(90deg, #fff, #a5f3fc 55%, #c4b5fd 90%); -webkit-background-clip:text; background-clip:text; color: transparent; }
    .glass { background: var(--glass); border: 1px solid rgba(255,255,255,.10); border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    .btn-acc { background: linear-gradient(90deg, var(--acc2), var(--acc)); border: none; color: #0b0f17 !important; font-weight: 700; }
    .progress-thin { height: 10px; }
    

    /* Brand & logo contrast */
    .navbar .navbar-brand span{
      font-weight:900; letter-spacing:.3px;
      background: linear-gradient(90deg,#FFFFFF 0%,#A5F3FC 55%,#C4B5FD 90%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color: transparent;
    }
    .navbar .navbar-brand .brand-accent{ filter: drop-shadow(0 0 8px rgba(124,58,237,.45)); }

    /* Inputs readable on dark */
    .form-control, .form-select { background-color:#111827; color:#EAF2FF; border:1px solid rgba(255,255,255,.18); }
    .form-control::placeholder{ color:#90A4C0; opacity:.9; }
    .form-select option{ color:#0b0f17; }

    /* Lesson text contrast */
    .lesson-title{ color:#EAF2FF; font-weight:800; letter-spacing:.2px; }
    .lesson-desc{ color:#CFE3FF; opacity:.95; }

    /* Quiz readability */
    .card.glass h5, .card.glass h4, .card.glass strong { color:#F6FAFF; }
    .btn-outline-light{ color:#EAF2FF; border-color:rgba(255,255,255,.35); }
    .progress.indeterminate .progress-bar{
  position: relative;
  width: 100% !important;
  background-color: #22d3ee; /* cyan */
  overflow: hidden;
}
#loadingBar{
  position: relative;
  overflow: hidden;
  border-radius: 8px;
}

.progress-thin{ height:18px; }
#loadingBar{ margin-top:10px; }
#loadingBar #loadingText{
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:.9rem; font-weight:600; color:#EAF2FF; pointer-events:none;
}
.quiz-result .result-text{ color:#EAF2FF !important; opacity:1 !important; }


/* kill Bootstrap's static fill color so the track doesn't look solid */
#loadingBar .progress-bar{
  background: transparent !important;
  width: 100% !important;
}

/* turn animation on by adding .active to #loadingBar */
#loadingBar.active::after{
  content:"";
  position:absolute; inset:0;
  background:
    linear-gradient(90deg,
      rgba(34,211,238,.15) 0%,
      rgba(34,211,238,.45) 50%,
      rgba(34,211,238,.15) 100%);
  background-size: 200% 100%;
  animation: sc-sheen 1s linear infinite;
  /* subtle tint for the track itself */
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
}
@keyframes sc-sheen{
  0%   { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
/* Force quiz score and similar status texts to be readable */
.quiz-result h4,
.quiz-result .result-text,
.quiz-score {
  color: #eaf2ff !important;
  opacity: 1 !important;
  text-shadow: none !important;
}
/* Tiny quiz loader uses container shimmer too */
#tinyLoadingBar{
  position: relative; overflow: hidden; border-radius: 8px;
  height: 12px;                           /* thin strip */
}
#tinyLoadingBar .progress-bar{ background: transparent !important; width:100% !important; }
#tinyLoadingBar.active::after{
  content:""; position:absolute; inset:0;
  background: linear-gradient(90deg,
    rgba(34,211,238,.15) 0%,
    rgba(34,211,238,.45) 50%,
    rgba(34,211,238,.15) 100%);
  background-size: 200% 100%;
  animation: sc-sheen 1s linear infinite;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
}

  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg nav-glass sticky-top px-3">
  <a class="navbar-brand d-flex align-items-center gap-2" href="/">
    <img src="{{ url_for('static', filename='Sattys.png') }}" alt="StudyCore logo"
         width="28" height="28" class="rounded-circle"
         style="box-shadow:0 0 0 2px rgba(255,255,255,.12);">
    <span>Studycore<span class="brand-accent"></span></span>
  </a>
  <div class="ms-auto d-flex gap-2">
    <a href="/upload" class="btn btn-sm btn-outline-light">Upload</a>
    <a href="#" class="btn btn-sm btn-acc">Login</a>
  </div>
</nav>

<header class="hero">
  
  <h1 class="display-6">AIStudyCore</h1>
  <p class="text-secondary">AI Study Guide. Flashcards. Quizzes. Upload Documents. Notetaking. And much more</p>
  <form method="POST" class="d-flex justify-content-center gap-2 mt-3">
    <input type="text" name="subject" class="form-control w-50 glass" placeholder="e.g. AP Human Geography, Algebra 2, Photosynthesis" required>
    <button class="btn btn-acc px-4">Generate</button>
  </form>
</header>

<div class="container">
  <!-- MAIN LOADING BAR -->
  <div id="loadingBar" class="progress progress-thin glass mb-3" style="display:none;">
  <div id="progressFill" class="progress-bar" role="progressbar"></div>
  <span id="loadingText">Generating, please wait‚Ä¶</span>
</div>




  {% if output %}
    {% if output.error %}
      <div class="alert alert-danger">{{ output.error }}</div>
    {% endif %}

    <ul class="nav nav-tabs glass ps-2" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#course">üìò AI Course</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#quiz">üß† Quiz</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#videos">üìº Extra Videos</button></li>
      <li class="nav-item">
        <form method="GET" class="m-0" action="/flashcards/{{ output.subject | urlencode }}">
          <button type="submit" class="nav-link">üìá Flashcards</button>
        </form>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="course">
        <div class="glass p-3 mt-3">
          <p class="mb-1 text-secondary">Course</p>
          <p class="mb-0">{{ output.plan }}</p>
        </div>

        {% for lesson in output.topics %}
        <div class="card glass mt-4">
          <div class="card-body">
            <h5 class="card-title lesson-title">üéì {{ lesson.title }}</h5>
            <p class="mb-3 lesson-desc">{{ lesson.description }}</p>
            {% if lesson.video %}
            <div class="ratio ratio-16x9 mb-3">
              <iframe src="{{ lesson.video | replace('watch?v=', 'embed/') }}" allowfullscreen></iframe>
            </div>
            {% endif %}
            {% if lesson.quiz %}
              <h6>üìù Quick Check</h6>
              {% for q in lesson.quiz %}
              <div class="mb-2">
                <strong>{{ q.question }}</strong>
                <div class="mt-2">
                  {% for opt in q.options %}
                  <button class="btn btn-sm btn-outline-light my-1 w-100 text-start"
                          onclick="checkLocalAnswer(this, '{{ opt[0] }}', '{{ q.answer }}')">
                    {{ opt }}
                  </button>
                  {% endfor %}
                </div>
              </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
        {% endfor %}

        <form method="POST" class="text-center my-4" id="continue-form">
          <input type="hidden" name="subject" value="{{ output.subject }}">
          {% for topic in output.topics %}
            <input type="hidden" name="past_topics" value="{{ topic.title }}">
            <input type="hidden" name="past_descriptions" value="{{ topic.description }}">
            <input type="hidden" name="past_videos" value="{{ topic.video }}">
            <input type="hidden" name="past_quizzes" value='{{ topic.quiz | tojson | safe }}'>
          {% endfor %}
          <button id="continueCourseBtn" class="btn btn-acc px-4" data-clicks="0">Continue Course</button>
        </form>
      </div>

      <div class="tab-pane fade" id="quiz">
        <div id="tinyLoadingBar" class="progress progress-thin glass mt-3" style="display:none;">
          <div id="tinyProgressFill" class="progress-bar" style="width:0%"></div>
        </div>
        <div id="mainQuizContainer" class="mt-3"></div>
      </div>

      <div class="tab-pane fade" id="videos">
        <div class="row g-3 mt-1">
          {% for video in output.videos %}
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card glass p-2 h-100">
              <a href="{{ video.link }}" target="_blank" class="text-decoration-none text-light">
                <img src="https://img.youtube.com/vi/{{ video.link.split('=')[-1] }}/0.jpg"
                     class="rounded w-100 mb-2" style="object-fit:cover; max-height:170px;">
                <div class="px-1 pb-2">
                  <div class="fw-semibold">{{ video.title }}</div>
                  <div class="text-secondary small">Open on YouTube ‚Üó</div>
                </div>
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}
</div>

{% if output %}
<script id="jinja-data" type="application/json">
{{ {"subject": output.subject, "topics": output.topics | map(attribute='title') | list } | tojson }}
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
function showLoadingBar(){
  const bar = document.getElementById("loadingBar");
  if(!bar) return;
  bar.style.display = "block";     // reveal
  // restart animation reliably
  bar.classList.remove("active");
  void bar.offsetWidth;            // force reflow
  bar.classList.add("active");
}
function hideLoadingBar(){
  const bar = document.getElementById("loadingBar");
  if(!bar) return;
  bar.classList.remove("active");
  bar.style.display = "none";
}

/* Trigger on Generate (no preventDefault) */
document.addEventListener("DOMContentLoaded", () => {
  const genForm = document.querySelector('form[method="POST"]');
  genForm?.addEventListener("submit", () => { showLoadingBar(); }, { once:true });
});
</script>


<script>
/* Main loading bar shows immediately on submit */


/* Quick‚Äëcheck buttons in lessons */
function checkLocalAnswer(button, selected, correct){
  const buttons = button.parentNode.querySelectorAll('button');
  buttons.forEach(b=>{
    b.disabled = true;
    const L = (b.textContent||"").trim().charAt(0);
    b.classList.remove('btn-outline-light');
    if(L===correct){ b.classList.add('btn-success'); }
    else if(b===button){ b.classList.add('btn-danger'); }
  });
}

/* Continue button limit */
document.addEventListener("DOMContentLoaded",()=>{
  const btn=document.getElementById("continueCourseBtn");
  if(btn){
    btn.addEventListener("click",(e)=>{
      let clicks = parseInt(btn.getAttribute("data-clicks"))||0;
      if(clicks>=4){ e.preventDefault(); alert("üö´ You‚Äôve reached the 4-time limit for continuing the course."); return; }
      btn.setAttribute("data-clicks", clicks+1);
    });
  }
});

/* ===== Main tab quiz (lazy build on first open) ===== */
let quizLoaded = false;
document.querySelector('[data-bs-target="#quiz"]')?.addEventListener('click', () => {
  if (quizLoaded) return;

  const tinyBar = document.getElementById("tinyLoadingBar");
  const tinyFill = document.getElementById("tinyProgressFill");
  const container = document.getElementById("mainQuizContainer");

  if (tinyBar) {
  tinyBar.style.display = "block";
  tinyBar.classList.remove("active"); void tinyBar.offsetWidth; tinyBar.classList.add("active");
}

  container.innerHTML = "<p class='text-secondary'>Generating quiz‚Ä¶</p>";

  const dataEl = document.getElementById("jinja-data");
  if (!dataEl) {
    if (tinyBar) tinyBar.style.display = "none";
    container.innerHTML = "<p>‚ö†Ô∏è Missing course data.</p>";
    return;
  }
  const { subject, topics } = JSON.parse(dataEl.textContent);

  fetch("/generate_quiz", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    subject: subject,
    topics: topics,
    studyguide_topics: window.studyguideTopics || null // Pass if available, else null
  })
})
.then(r => r.json())
.then(data => {
  if (tinyBar) {
    tinyBar.classList.remove("active");
    tinyBar.style.display = "none";
  }

    if (!Array.isArray(data.quiz)) { container.innerHTML = "<p>‚ùå Failed to load quiz. Please try again.</p>"; return; }

    let i = 0, score = 0;

    const render = () => {
      const q = data.quiz[i]; if (!q) return;
      const opts = (q.options || []).map(opt => {
        const L = opt.trim().charAt(0);
        return `<button class="btn btn-outline-light btn-answer w-100 my-1 text-start" data-letter="${L}">${opt}</button>`;
      }).join("");
      const nav = (i < data.quiz.length - 1)
        ? `<button class="btn btn-secondary" data-action="next">Next</button>`
        : `<button class="btn btn-acc" data-action="finish">Finish</button>`;

      container.innerHTML = `
        <div class="card glass p-3">
          <h5>${q.question}</h5>
          <div class="mt-3">${opts}</div>
          <div class="d-flex justify-content-between mt-3">
            <button class="btn btn-sm btn-outline-light" data-action="how">üß† How to solve</button>
            ${nav}
          </div>
        </div>`;
    };

    container.onclick = (e) => {
      const btn = e.target.closest("button"); if (!btn) return;
      const act = btn.getAttribute("data-action");

      if (btn.classList.contains("btn-answer")) {
        const corr = (data.quiz[i].answer || "").trim().charAt(0);
        const all = [...container.querySelectorAll(".btn-answer")];
        all.forEach(b => {
          const L = b.dataset.letter;
          b.disabled = true;
          b.classList.remove("btn-outline-light");
          if (L === corr) b.classList.add("btn-success");
          else if (b === btn) b.classList.add("btn-danger");
        });
        if (btn.dataset.letter === corr) score++;
        return;
      }
      if (act === "next") { i++; render(); return; }
      if (act === "finish") {
  const pct = Math.round((score / data.quiz.length) * 100);
  container.innerHTML = `
    <div class="card glass p-4 text-center quiz-result">
      <h4>‚úÖ Quiz Complete!</h4>
      <p class="result-text">Your Score: ${score} / ${data.quiz.length} (${pct}%)</p>

      <div class="d-flex justify-content-center gap-2 mt-3">
        <button class="btn btn-outline-light" data-action="retry">üîÅ Retry</button>
        <button class="btn btn-acc" data-action="regen">‚ôªÔ∏è Regenerate</button>
      </div>
    </div>`;
  return;
}

      if (act === "retry") { i = 0; score = 0; render(); return; }
      if (act === "regen") { quizLoaded = false; document.querySelector('[data-bs-target="#quiz"]').click(); return; }
      if (act === "how") { alert("üß† How to solve coming soon!"); return; }
    };

    render();
    quizLoaded = true;
  })
  .catch(err => {
    console.error(err);
    if (tinyBar) tinyBar.style.display = "none";
    container.innerHTML = "<p>‚ùå Error generating quiz.</p>";
  });
});
</script>
</body>
</html>
