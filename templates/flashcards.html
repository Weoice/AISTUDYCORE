<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flashcards ‚Äì {{ subject }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: black;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    /* Full-page flashcard loader */
    #flashcard-loader {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background:black;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      z-index:2000;
    }
    #flashcard-loader p {
      margin-top:1rem;
      color:#bbb;
      font-size:1.1rem;
      text-align:center;
    }
    /* Main content hidden until ready */
    #flashcardsContent {
      display:none;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #flashcardsContent.show {
      opacity:1;
    }
    /* Flashcard styling */
    .flashcard {
      width:80%; max-width:600px;
      height:60vh; margin:40px auto;
      perspective:1000px;
    }
    .card-inner {
      position:relative;
      width:100%; height:100%;
      transition:transform 0.8s;
      transform-style:preserve-3d;
    }
    .card-inner.flipped {
      transform:rotateY(180deg);
    }
    .card-front, .card-back {
      position:absolute; width:100%; height:100%;
      backface-visibility:hidden;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #ccc; border-radius:12px;
      padding:10px; background:#222;
      font-size:1.3rem;
    }
    .card-back {
      transform:rotateY(180deg);
    }
    /* Vocab table */
    table.vocab-table {
      margin-top:30px; width:100%;
      font-size:0.85rem; opacity:0.7;
    }
    table.vocab-table th,
    table.vocab-table td {
      border:1px solid white; padding:10px;
    }
  </style>
</head>
<body>

  <!-- Flashcard loader overlay -->
  <div id="flashcard-loader">
    <div class="spinner-border text-light" role="status">
      <span class="visually-hidden">Loading‚Ä¶</span>
    </div>
    <p>Generating flashcards‚Ä¶<br>this may take a moment.</p>
  </div>

  <!-- Main flashcards content -->
  <div id="flashcardsContent">
    <h1 class="text-center">üìá Flashcards for ‚Äú{{ subject }}‚Äù</h1>

    <div class="flashcard">
      <div class="card-inner" id="card-inner">
        <div class="card-front" id="flashcard-front">Loading‚Ä¶</div>
        <div class="card-back" id="flashcard-back">Loading‚Ä¶</div>
      </div>
      <p class="text-center mt-2" id="card-count">Card 1 of 10</p>
    </div>

    <div class="text-center mb-4">
      <button class="btn btn-light me-2" onclick="flipCard()">Flip</button>
      <button class="btn btn-secondary" onclick="nextCard()">Next</button>
    </div>

    <h3 class="mt-5">üß† Vocabulary Table</h3>
    <table class="vocab-table table table-dark table-striped">
      <thead>
        <tr><th>Term</th><th>Definition</th></tr>
      </thead>
      <tbody id="vocab-body"></tbody>
    </table>

    <h3 class="mt-5">üìù Generate Quiz</h3>
    <form id="quizForm" class="d-flex align-items-center mb-3">
      <label class="me-2 mb-0"># Questions:</label>
      <input id="questionCount" type="number" value="5" min="1" max="15"
             class="form-control w-25 me-3">
      <label class="me-2 mb-0">Difficulty:</label>
      <select id="difficulty" class="form-select w-auto me-3">
        <option>Easy</option>
        <option selected>Medium</option>
        <option>Hard</option>
      </select>
      <button type="submit" class="btn btn-info">Generate Quiz</button>
    </form>

    <!-- Quiz loader -->
    <div id="quiz-loader" class="text-center mb-3" style="display:none;">
      <div class="spinner-border text-info" role="status">
        <span class="visually-hidden">Loading quiz‚Ä¶</span>
      </div>
      <p class="mt-2" style="color:#00bcd4;">Generating quiz‚Ä¶</p>
    </div>

    <!-- Quiz container -->
    <div id="quiz-section"></div>

    <div class="text-center mt-4">
      <button class="btn btn-outline-light" onclick="window.history.back()">
        üîô Back to Course
      </button>
    </div>
  </div>

  <!-- Flashcards loader & fetch script -->
  <script>
    function showContent() {
      document.getElementById("flashcard-loader").style.display = "none";
      const c = document.getElementById("flashcardsContent");
      c.style.display = "block";
      setTimeout(() => c.classList.add("show"), 10);
    }
    function hideContent() {
      const c = document.getElementById("flashcardsContent");
      c.classList.remove("show");
      c.style.display = "none";
      document.getElementById("flashcard-loader").style.display = "flex";
    }

    let flashcards = [], current = 0;

    function loadCard(i) {
      const fc = flashcards[i] || {};
      document.getElementById("flashcard-front").innerText = fc.term || "N/A";
      document.getElementById("flashcard-back").innerText  = fc.definition || "N/A";
      document.getElementById("card-count").innerText = `Card ${i+1} of ${flashcards.length}`;
    }

    function populateVocabTable() {
      const tbody = document.getElementById("vocab-body");
      tbody.innerHTML = "";
      flashcards.forEach(fc => {
        tbody.innerHTML += `<tr><td>${fc.term}</td><td>${fc.definition}</td></tr>`;
      });
    }

    function renderFlashcardPage() {
      current = 0;
      if (!flashcards.length) {
        document.getElementById("card-count").innerText = "No flashcards.";
        document.getElementById("flashcard-front").innerText = "‚Äì";
        document.getElementById("flashcard-back").innerText  = "‚Äì";
      } else {
        loadCard(0);
        populateVocabTable();
      }
    }

    async function fetchFlashcards() {
      hideContent();
      try {
        const res = await fetch("/generate_flashcards_from_subject", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ subject: "{{ subject }}" })
        });
        if (!res.ok) throw new Error(`Server returned ${res.status}`);
        const data = await res.json();
        let cards = [];
        if (Array.isArray(data.flashcards)) {
          cards = data.flashcards;
        } else if (Array.isArray(data)) {
          cards = data;
        } else if (data.success && Array.isArray(data.flashcards)) {
          cards = data.flashcards;
        } else {
          throw new Error(data.error || "Invalid response format");
        }
        flashcards = cards;
        sessionStorage.setItem("flashcardsData", JSON.stringify(cards));
        renderFlashcardPage();
      } catch (err) {
        console.error("Error loading flashcards:", err);
        document.getElementById("flashcardsContent").innerHTML = `
          <h1 class="text-center">‚ùå Failed to load flashcards</h1>
          <p class="text-danger text-center">${err.message}</p>
          <div class="text-center mt-4">
            <button class="btn btn-outline-light" onclick="window.history.back()">
              üîô Back to Course
            </button>
          </div>`;
      } finally {
        showContent();
      }
    }

    function loadOrFetchFlashcards(){
      const cached = sessionStorage.getItem("flashcardsData");
      if (cached) {
        try { flashcards = JSON.parse(cached); }
        catch {}
        renderFlashcardPage();
        return showContent();
      }
      fetchFlashcards();
    }

    function flipCard(){
      document.getElementById("card-inner").classList.toggle("flipped");
    }
    function nextCard(){
      current = (current + 1) % flashcards.length;
      document.getElementById("card-inner").classList.remove("flipped");
      loadCard(current);
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadOrFetchFlashcards();
    });
  </script>

  <!-- Quiz script with its own loader -->
  <script>
    function showQuizLoader(){
      document.getElementById("quiz-loader").style.display = "block";
    }
    function hideQuizLoader(){
      document.getElementById("quiz-loader").style.display = "none";
    }

    let quizData = [], qi = 0, qs = 0;

    function renderQuizQuestion(){
      const c = document.getElementById("quiz-section");
      if (!quizData.length){
        c.innerHTML = "<p>No quiz available.</p>";
        return;
      }
      if (qi >= quizData.length){
        const pct = Math.round((qs/quizData.length)*100);
        c.innerHTML = `
          <div class="card p-4 text-center">
            <h4>‚úÖ Quiz Complete!</h4>
            <p>Your Score: ${qs} / ${quizData.length} (${pct}%)</p>
            <button class="btn btn-outline-primary btn-retry mt-3">üîÅ Retry Quiz</button>
          </div>`;
        return;
      }
      const q = quizData[qi];
      let html = `<div class="card p-3"><h5>${q.question}</h5><div class="mt-3">`;
      q.options.forEach(o=>{
        const L = o.trim().charAt(0).toUpperCase();
        html += `<button class="btn btn-outline-primary btn-answer w-100 my-1" data-letter="${L}">${o}</button>`;
      });
      html += `</div><div class="d-flex justify-content-between mt-3">`;
      if (qi < quizData.length-1){
        html += `<button class="btn btn-secondary btn-next">Next</button>`;
      } else {
        html += `<button class="btn btn-success btn-finish">Finish</button>`;
      }
      html += `</div></div>`;
      c.innerHTML = html;
    }

    document.getElementById("quiz-section").addEventListener("click", e => {
      const t = e.target;
      if (t.matches(".btn-answer")){
        const sel = t.dataset.letter;
        const corr = quizData[qi].answer.trim().charAt(0).toUpperCase();
        document.querySelectorAll("#quiz-section .btn-answer").forEach(b=>{
          b.disabled = true;
          const L = b.dataset.letter;
          b.classList.remove("btn-outline-primary");
          if (L === corr) b.classList.add("btn-success");
          else if (b === t) b.classList.add("btn-danger");
        });
        if (sel === corr) qs++;
        return;
      }
      if (t.matches(".btn-next")){
        qi++; renderQuizQuestion(); return;
      }
      if (t.matches(".btn-finish")){
        qi++; renderQuizQuestion(); return;
      }
      if (t.matches(".btn-retry")){
        qi = qs = 0; renderQuizQuestion(); return;
      }
    });

    async function generateQuiz(){
      showQuizLoader();
      document.getElementById("quiz-section").innerHTML = "";
      try {
        const count = parseInt(document.getElementById("questionCount").value);
        const diff  = document.getElementById("difficulty").value;
        const res = await fetch("/generate_flashcard_quiz", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({
            subject:"{{ subject }}",
            questionCount:count,
            difficulty:diff
          })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        if (!data.success || !Array.isArray(data.quiz)) throw new Error("Bad quiz data");
        quizData = data.quiz; qi = qs = 0;
        renderQuizQuestion();
      } catch (err) {
        console.error("Quiz error:", err);
        alert("‚ùå Error generating quiz.");
      } finally {
        hideQuizLoader();
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("quizForm").addEventListener("submit", e=>{
        e.preventDefault();
        generateQuiz();
      });
    });
  </script>

</body>
</html>
